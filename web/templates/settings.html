<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè®¾ç½® - go-news</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav>
        <a href="/articles?status=processed">ğŸ“° æ–‡ç« </a>
        <a href="/feeds">ğŸ“¡ è®¢é˜…æº</a>
        <a href="/settings">âš™ï¸ è®¾ç½®</a>
        <a href="/status">ğŸ“Š çŠ¶æ€</a>
    </nav>
    <main>
        <div class="settings-page">
            <h2>ç³»ç»Ÿè®¾ç½®</h2>

            <form id="settings-form" onsubmit="saveSettings(event)">
                <fieldset>
                    <legend>LLMé…ç½®</legend>
                    <label>
                        æä¾›å•†
                        <select name="llm_provider" id="llm_provider" onchange="updateProviderHints()">
                            <option value="openai" {{if eq .config.llm_provider "openai"}}selected{{end}}>OpenAI</option>
                            <option value="ollama" {{if eq .config.llm_provider "ollama"}}selected{{end}}>Ollama</option>
                            <option value="google" {{if eq .config.llm_provider "google"}}selected{{end}}>Google AI Studio</option>
                        </select>
                    </label>
                    <label>
                        APIåœ°å€
                        <input type="url" name="llm_api_url" id="llm_api_url" value="{{.config.llm_api_url}}">
                        <small id="api_url_hint" style="color: #666; font-size: 0.85rem;"></small>
                    </label>
                    <label>
                        APIå¯†é’¥
                        <input type="password" name="llm_api_key" value="{{.config.llm_api_key}}">
                    </label>
                    <label>
                        æ¨¡å‹
                        <input type="text" name="llm_model" id="llm_model" value="{{.config.llm_model}}">
                    </label>
                    <div class="button-group">
                        <button type="button" onclick="getModels()">ğŸ“‹ è·å–æ¨¡å‹åˆ—è¡¨</button>
                        <button type="button" onclick="testConnection()">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
                    </div>
                    <div id="test-result" class="test-result"></div>
                </fieldset>

                <fieldset>
                    <legend>æç¤ºè¯</legend>
                    <label>
                        ç­›é€‰æç¤ºè¯
                        <textarea name="prompt_filter" rows="5">{{.config.prompt_filter}}</textarea>
                    </label>
                    <label>
                        æ‘˜è¦æç¤ºè¯
                        <textarea name="prompt_summary" rows="5">{{.config.prompt_summary}}</textarea>
                    </label>
                </fieldset>

                <button type="submit">ä¿å­˜è®¾ç½®</button>
            </form>
        </div>
    </main>

    <script>
    async function saveSettings(e) {
        e.preventDefault();
        const form = e.target;
        const data = {};

        new FormData(form).forEach((value, key) => {
            data[key] = value;
        });

        await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        alert('ä¿å­˜æˆåŠŸ');
    }

    async function getModels() {
        const resultDiv = document.getElementById('test-result');
        resultDiv.innerHTML = '<p style="color: #666;">æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</p>';

        try {
            const resp = await fetch('/api/llm/models');
            const data = await resp.json();

            if (resp.ok && data.models) {
                if (data.models.length === 0) {
                    resultDiv.innerHTML = '<p style="color: #ff9800;">æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</p>';
                    return;
                }

                const modelList = data.models.map(m =>
                    `<div class="model-item" onclick="selectModel('${m}')">${m}</div>`
                ).join('');

                resultDiv.innerHTML = `
                    <p style="color: #4caf50; margin-bottom: 8px;">æ‰¾åˆ° ${data.models.length} ä¸ªæ¨¡å‹,ç‚¹å‡»é€‰æ‹©:</p>
                    <div class="model-list">${modelList}</div>
                `;
            } else {
                resultDiv.innerHTML = `<p style="color: #f44336;">âŒ ${data.error || 'è·å–å¤±è´¥'}</p>`;
            }
        } catch (err) {
            resultDiv.innerHTML = `<p style="color: #f44336;">âŒ è¯·æ±‚å¤±è´¥: ${err.message}</p>`;
        }
    }

    function selectModel(modelId) {
        document.getElementById('llm_model').value = modelId;
        document.getElementById('test-result').innerHTML =
            `<p style="color: #4caf50;">âœ… å·²é€‰æ‹©æ¨¡å‹: ${modelId}</p>`;
    }

    async function testConnection() {
        const resultDiv = document.getElementById('test-result');
        resultDiv.innerHTML = '<p style="color: #666;">æ­£åœ¨æµ‹è¯•è¿æ¥...</p>';

        try {
            const resp = await fetch('/api/llm/test', {method: 'POST'});
            const data = await resp.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <p style="color: #4caf50;">âœ… ${data.message}</p>
                    <p style="color: #666;">LLM å“åº”: ${data.response}</p>
                `;
            } else {
                resultDiv.innerHTML = `<p style="color: #f44336;">âŒ ${data.error}</p>`;
            }
        } catch (err) {
            resultDiv.innerHTML = `<p style="color: #f44336;">âŒ è¯·æ±‚å¤±è´¥: ${err.message}</p>`;
        }
    }

    function updateProviderHints() {
        const provider = document.getElementById('llm_provider').value;
        const apiUrlInput = document.getElementById('llm_api_url');
        const apiUrlHint = document.getElementById('api_url_hint');

        switch(provider) {
            case 'openai':
                apiUrlHint.textContent = 'ç¤ºä¾‹: https://api.openai.com/v1';
                if (!apiUrlInput.value) apiUrlInput.value = 'https://api.openai.com/v1';
                break;
            case 'ollama':
                apiUrlHint.textContent = 'ç¤ºä¾‹: http://localhost:11434/v1';
                if (!apiUrlInput.value) apiUrlInput.value = 'http://localhost:11434/v1';
                break;
            case 'google':
                apiUrlHint.textContent = 'ç¤ºä¾‹: https://generativelanguage.googleapis.com';
                if (!apiUrlInput.value || apiUrlInput.value.includes('openai') || apiUrlInput.value.includes('ollama')) {
                    apiUrlInput.value = 'https://generativelanguage.googleapis.com';
                }
                break;
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ›´æ–°æç¤º
    window.addEventListener('DOMContentLoaded', updateProviderHints);
    </script>
</body>
</html>
