<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»ŸçŠ¶æ€ - go-news</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav>
        <a href="/articles?status=processed">ğŸ“° æ–‡ç« </a>
        <a href="/feeds">ğŸ“¡ è®¢é˜…æº</a>
        <a href="/settings">âš™ï¸ è®¾ç½®</a>
        <a href="/status">ğŸ“Š çŠ¶æ€</a>
    </nav>
    <main>
        <div class="status-page">
            <h2>ç³»ç»ŸçŠ¶æ€</h2>

            <div class="status-grid">
                <div class="status-card">
                    <h3>æ–‡ç« ç»Ÿè®¡</h3>
                    <div class="stat-item">
                        <span class="stat-label">æ€»è®¡:</span>
                        <span class="stat-value" id="total-articles">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å¾…å¤„ç†:</span>
                        <span class="stat-value pending" id="pending-articles">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å·²å¤„ç†:</span>
                        <span class="stat-value processed" id="processed-articles">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å·²è¿‡æ»¤:</span>
                        <span class="stat-value filtered" id="filtered-articles">-</span>
                    </div>
                </div>

                <div class="status-card">
                    <h3>è®¢é˜…æºç»Ÿè®¡</h3>
                    <div class="stat-item">
                        <span class="stat-label">æ€»è®¡:</span>
                        <span class="stat-value" id="total-feeds">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å·²å¯ç”¨:</span>
                        <span class="stat-value enabled" id="enabled-feeds">-</span>
                    </div>
                </div>

                <div class="status-card">
                    <h3>å®šæ—¶ä»»åŠ¡</h3>
                    <div class="stat-item">
                        <span class="stat-label">ä¸‹æ¬¡æŠ“å–:</span>
                        <span class="stat-value" id="next-fetch">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ä¸‹æ¬¡å¤„ç†:</span>
                        <span class="stat-value" id="next-process">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å½“å‰æ—¶é—´:</span>
                        <span class="stat-value" id="current-time">-</span>
                    </div>
                </div>

                <div class="status-card">
                    <h3>å¤„ç†è¿›åº¦</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                        <div class="progress-text" id="progress-text">0%</div>
                    </div>
                    <div class="stat-item" style="margin-top: 1rem;">
                        <span class="stat-label">å®Œæˆç‡:</span>
                        <span class="stat-value" id="completion-rate">-</span>
                    </div>
                </div>
            </div>

            <div class="actions" style="margin-top: 2rem;">
                <button onclick="loadStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>
    </main>

    <script>
    function formatTime(timeStr) {
        if (!timeStr || timeStr === '0001-01-01T00:00:00Z') return '-';
        const date = new Date(timeStr);
        const now = new Date();
        const diff = Math.floor((date - now) / 1000);

        if (diff < 0) return 'å³å°†æ‰§è¡Œ';
        if (diff < 60) return `${diff} ç§’å`;
        if (diff < 3600) return `${Math.floor(diff / 60)} åˆ†é’Ÿå`;
        if (diff < 86400) return `${Math.floor(diff / 3600)} å°æ—¶å`;

        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    async function loadStatus() {
        try {
            const resp = await fetch('/api/status');
            const data = await resp.json();

            // æ–‡ç« ç»Ÿè®¡
            document.getElementById('total-articles').textContent = data.total_articles || 0;
            document.getElementById('pending-articles').textContent = data.pending_articles || 0;
            document.getElementById('processed-articles').textContent = data.processed_articles || 0;
            document.getElementById('filtered-articles').textContent = data.filtered_articles || 0;

            // è®¢é˜…æºç»Ÿè®¡
            document.getElementById('total-feeds').textContent = data.total_feeds || 0;
            document.getElementById('enabled-feeds').textContent = data.enabled_feeds || 0;

            // å®šæ—¶ä»»åŠ¡
            document.getElementById('next-fetch').textContent = formatTime(data.next_fetch_time);
            document.getElementById('next-process').textContent = formatTime(data.next_process_time);

            // è®¡ç®—å¤„ç†è¿›åº¦
            const total = data.total_articles || 0;
            const pending = data.pending_articles || 0;
            const processed = (data.processed_articles || 0) + (data.filtered_articles || 0);
            const percentage = total > 0 ? Math.round((processed / total) * 100) : 0;

            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = percentage + '%';
            document.getElementById('completion-rate').textContent = `${processed} / ${total} (${percentage}%)`;

        } catch (err) {
            console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', err);
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    loadStatus();
    updateCurrentTime();

    // æ¯ç§’æ›´æ–°å½“å‰æ—¶é—´
    setInterval(updateCurrentTime, 1000);

    // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
    setInterval(loadStatus, 5000);
    </script>
</body>
</html>
